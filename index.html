<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Biblioteca Documentos</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://upload-widget.cloudinary.com/latest/global/all.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; color:#1a202c; }
    .container { max-width:1200px; margin:0 auto; padding:2rem; }
    .header { text-align:center; margin-bottom:2rem; }
    .header h2 { color:white; font-weight:bold; }
    .card { background:white; border-radius:16px; margin-bottom:2rem; box-shadow:0 4px 12px rgba(0,0,0,.1); }
    .card-header { padding:1rem; background:linear-gradient(135deg,#667eea,#764ba2); color:white; border-radius:16px 16px 0 0; }
    .card-body { padding:1.5rem; }
    .upload-zone { border:2px dashed #667eea; border-radius:12px; padding:2rem; text-align:center; cursor:pointer; }
    .btn { padding:0.5rem 1rem; border:none; border-radius:8px; cursor:pointer; margin:0.2rem; }
    .btn-primary { background:#667eea; color:white; }
    .btn-secondary { background:#e2e8f0; }
    .btn-success { background:#38a169; color:white; }
    .btn-danger { background:#e53e3e; color:white; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; }
    th,td { padding:0.75rem; border-bottom:1px solid #e2e8f0; }
    th { background:#667eea; color:white; text-align:left; }
    .no-documents { text-align:center; padding:1rem; color:#718096; }
    #fileInput { display:none; }
    .loading { display:none; text-align:center; padding:1rem; color:#667eea; }
    .spinner { width:20px; height:20px; border:3px solid #f3f3f3; border-top:3px solid #667eea; border-radius:50%; animation:spin 1s linear infinite; display:inline-block; }
    @keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2><i class="fas fa-file-alt"></i> Biblioteca de Documentos</h2>
      <p style="color:white;">Importa y gestiona tus archivos PDF y DOC</p>
    </div>

    <!-- Subida -->
    <div class="card">
      <div class="card-header"><h3><i class="fas fa-cloud-upload-alt"></i> Subir Documentos</h3></div>
      <div class="card-body">
        <div class="upload-zone" id="fileDropZone">
          <i class="fas fa-cloud-upload-alt fa-2x"></i>
          <p>Arrastra o haz clic para seleccionar archivos (PDF, DOC, DOCX)</p>
          <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Seleccionar Archivos</button>
          <button class="btn btn-secondary" id="cloudinaryUpload"><i class="fas fa-cloud"></i> Subir con Cloudinary</button>
        </div>
        <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx">
      </div>
    </div>

    <!-- Mensajes -->
    <div id="messageContainer"></div>
    <div id="loadingIndicator" class="loading"><div class="spinner"></div> Procesando...</div>

    <!-- Documentos -->
    <div class="card">
      <div class="card-header"><h3><i class="fas fa-list"></i> Documentos Almacenados</h3></div>
      <div class="card-body">
        <div class="table-container">
          <table>
            <thead><tr><th>Documento</th><th>Fecha</th><th>Tama√±o</th><th>Acciones</th></tr></thead>
            <tbody id="documentsTableBody">
              <tr><td colspan="4" class="no-documents">No hay documentos</td></tr>
            </tbody>
          </table>
        </div>
        <p id="totalElements">Total: 0 elementos</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCpPdY984mCYWQodeqA6ZVXFxedalExc34",
      authDomain: "repositorio-documentos.firebaseapp.com",
      projectId: "repositorio-documentos",
      storageBucket: "repositorio-documentos.firebasestorage.app",
      messagingSenderId: "359488594361",
      appId: "1:359488594361:web:421264bbc3c5f8f7c01668"
    };

    const CLOUDINARY_CONFIG = { cloudName: "dbzucruu4", uploadPreset: "documentos_defensoria" };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function showMessage(msg, type='info'){document.getElementById('messageContainer').innerHTML=`<p style="color:${type==='error'?'red':'green'}">${msg}</p>`;}
    function showLoading(show=true){document.getElementById('loadingIndicator').style.display=show?'block':'none';}
    function formatFileSize(b){if(b===0)return"0B";const k=1024,sizes=['B','KB','MB','GB'],i=Math.floor(Math.log(b)/Math.log(k));return (b/Math.pow(k,i)).toFixed(1)+' '+sizes[i];}

    class DocumentManager {
      constructor(){this.collectionRef=collection(db,"documents");this.documents=[];this.init();}
      async init(){this.setupFileUpload();this.setupCloudinary();await this.loadDocuments();}
      async loadDocuments(){
        showLoading(true);
        const q=query(this.collectionRef, orderBy("uploadedAt","desc"));
        const snap=await getDocs(q);
        this.documents=snap.docs.map(d=>({id:d.id,...d.data()}));
        this.renderTable();
        showLoading(false);
      }
      setupFileUpload(){
        const fi=document.getElementById("fileInput");
        const dz=document.getElementById("fileDropZone");
        dz.addEventListener("click",()=>fi.click());
        fi.addEventListener("change",(e)=>this.handleFiles(e.target.files));
      }
      async handleFiles(files){for(const f of files){await this.uploadFileToCloudinary(f);}await this.loadDocuments();}
      
      async uploadFileToCloudinary(file){
        return new Promise((resolve,reject)=>{
          const fd=new FormData();
          fd.append("file",file);
          fd.append("upload_preset",CLOUDINARY_CONFIG.uploadPreset);
          fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/raw/upload`,{method:"POST",body:fd})
          .then(r=>r.json()).then(async res=>{
            if(res.error){showMessage("Error: "+res.error.message,"error");return reject(res.error);}
            const docData={name:res.original_filename+'.'+res.format,size:res.bytes,uploadedAt:new Date().toISOString(),url:res.secure_url,cloudinaryId:res.public_id};
            await addDoc(this.collectionRef,docData);
            showMessage(file.name+" subido correctamente","success");
            resolve(res);
          }).catch(err=>{showMessage("Error al subir","error");reject(err);});
        });
      }

      setupCloudinary(){
        if(typeof cloudinary==='undefined')return;
        this.widget=cloudinary.createUploadWidget({cloudName:CLOUDINARY_CONFIG.cloudName,uploadPreset:CLOUDINARY_CONFIG.uploadPreset,clientAllowedFormats:["pdf","doc","docx"],resource_type:"raw"},
        async (err,res)=>{if(res&&res.event==="success"){const d={name:res.info.original_filename+'.'+res.info.format,size:res.info.bytes,uploadedAt:new Date().toISOString(),url:res.info.secure_url,cloudinaryId:res.info.public_id};await addDoc(this.collectionRef,d);this.loadDocuments();}});
        document.getElementById("cloudinaryUpload").addEventListener("click",()=>this.widget.open());
      }

      async deleteDocument(id){if(!confirm("Eliminar documento?"))return;await deleteDoc(doc(db,"documents",id));await this.loadDocuments();}
      
      renderTable(){
        const tbody=document.getElementById("documentsTableBody");
        if(!this.documents.length){tbody.innerHTML='<tr><td colspan="4" class="no-documents">No hay documentos</td></tr>';document.getElementById("totalElements").textContent="Total: 0 elementos";return;}
        tbody.innerHTML=this.documents.map(doc=>`<tr>
          <td>${doc.name}</td>
          <td>${new Date(doc.uploadedAt).toLocaleString("es-ES")}</td>
          <td>${formatFileSize(doc.size)}</td>
          <td><a href="${doc.url}" target="_blank" class="btn btn-sm btn-primary">Ver</a>
              <button class="btn btn-sm btn-danger" onclick="documentManager.deleteDocument('${doc.id}')">Eliminar</button></td>
        </tr>`).join('');
        document.getElementById("totalElements").textContent="Total: "+this.documents.length+" elementos";
      }
    }

    window.addEventListener("DOMContentLoaded",()=>{window.documentManager=new DocumentManager();});
  </script>
</body>
</html>
