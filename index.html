<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Documentos Persistente</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://upload-widget.cloudinary.com/latest/global/all.js"></script>
  <style>
    body {font-family: 'Inter', sans-serif; background: #f9fafb; margin:0; padding:20px;}
    .container {background: #fff; padding:20px; border-radius:12px; max-width:1000px; margin:auto; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
    h1 {color:#2563eb; text-align:center;}
    .file-drop-zone {border:2px dashed #ccc; border-radius:10px; padding:40px; text-align:center; margin-bottom:20px; cursor:pointer;}
    .file-drop-zone:hover {border-color:#2563eb; background:#eff6ff;}
    .btn {padding:6px 12px; border:none; border-radius:6px; cursor:pointer; margin:2px;}
    .btn-info {background:#2563eb; color:white;}
    .btn-danger {background:#ef4444; color:white;}
    .btn-edit {background:#6b7280; color:white;}
    .btn-print {background:#10b981; color:white;}
    .filters {display:flex; flex-wrap:wrap; justify-content:space-between; margin-bottom:10px; gap:10px;}
    .filters input, .filters select {padding:6px; border:1px solid #ddd; border-radius:6px;}
    .table-container {overflow-x:auto;}
    table {width:100%; border-collapse:collapse;}
    th,td {padding:10px; border-bottom:1px solid #ddd; font-size:0.9em; text-align:center;}
    th {background:#2563eb; color:white;}
    tr:hover {background:#f3f4f6;}
    .pagination {display:flex; justify-content:center; align-items:center; gap:10px; margin-top:15px;}
    .badge {padding:2px 6px; border-radius:6px; font-size:0.75em; color:white;}
    .badge-cloud {background:#2563eb;}
    .badge-local {background:#6b7280;}
  </style>
</head>
<body>
  <div class="container">
    <h1>üìÇ Gestor de <span style="color:#2563eb;">Documentos</span></h1>

    <!-- Drop Zone -->
    <div id="fileDropZone" class="file-drop-zone">
      <i class="fas fa-cloud-upload-alt" style="font-size:2em; color:#2563eb;"></i>
      <h3>Arrastra archivos aqu√≠ o haz clic</h3>
      <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt" style="display:none;">
    </div>

    <!-- Bot√≥n Cloudinary -->
    <div style="text-align:center; margin-bottom:20px;">
      <button id="upload_widget" class="btn btn-info"><i class="fas fa-upload"></i> Subir con Cloudinary</button>
    </div>

    <!-- Filtros -->
    <div class="filters">
      <input type="text" id="searchInput" placeholder="Buscar...">
      <select id="originFilter">
        <option value="all">Todos</option>
        <option value="cloudinary">Solo Cloudinary</option>
        <option value="local">Solo Local</option>
      </select>
    </div>

    <!-- Tabla -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Descripci√≥n</th>
            <th>Fecha</th>
            <th>Tama√±o</th>
            <th>Origen</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="importedDocumentsTableBody">
          <tr><td colspan="6" style="text-align:center;">No hay documentos</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    class DocumentManager {
      constructor() {
        // Cargar desde localStorage al iniciar
        this.documents = JSON.parse(localStorage.getItem("documents") || "[]");
        this.currentPage = 1;
        this.itemsPerPage = 10;
        this.setupFileUpload();
        this.setupCloudinary();
        this.setupFilters();
        this.loadImportedDocuments();
      }

      // --- Subida local ---
      setupFileUpload(){
        const drop=document.getElementById("fileDropZone");
        const input=document.getElementById("fileInput");
        drop.addEventListener("click",()=>input.click());
        drop.addEventListener("dragover",e=>{e.preventDefault();});
        drop.addEventListener("drop",e=>{e.preventDefault();this.handleFileSelection(e.dataTransfer.files);});
        input.addEventListener("change",e=>this.handleFileSelection(e.target.files));
      }
      handleFileSelection(files){
        Array.from(files).forEach(f=>{
          const reader=new FileReader();
          reader.onload=()=>{
            const doc={id:Date.now(),name:f.name,description:"Documento local",size:f.size,uploadedAt:new Date().toISOString(),data:reader.result};
            this.documents.push(doc);
            localStorage.setItem("documents",JSON.stringify(this.documents));
            this.loadImportedDocuments();
          };
          reader.readAsDataURL(f);
        });
      }

      // --- Subida Cloudinary ---
      setupCloudinary(){
        if(typeof cloudinary==='undefined')return;
        const widget=cloudinary.createUploadWidget(
          {cloudName:'dbzucruu4',uploadPreset:'documentos_defensoria'},
          (err,res)=>{
            if(res.event==="success"){
              const doc={
                id:Date.now(),
                name:res.info.original_filename+"."+res.info.format,
                description:"Documento subido a Cloudinary",
                size:res.info.bytes,
                uploadedAt:new Date().toISOString(),
                url:res.info.secure_url
              };
              this.documents.push(doc);
              localStorage.setItem("documents",JSON.stringify(this.documents));
              this.loadImportedDocuments();
            }
          }
        );
        document.getElementById("upload_widget").addEventListener("click",()=>widget.open(),false);
      }

      // --- Filtros ---
      setupFilters(){
        document.getElementById("searchInput").addEventListener("input",()=>this.loadImportedDocuments());
        document.getElementById("originFilter").addEventListener("change",()=>this.loadImportedDocuments());
      }

      // --- Filtrado y render ---
      getFilteredDocuments(){
        const q=document.getElementById("searchInput").value.toLowerCase();
        const origin=document.getElementById("originFilter").value;
        return this.documents.filter(d=>{
          const matches=d.name.toLowerCase().includes(q)||d.description.toLowerCase().includes(q);
          let ok=true;
          if(origin==="cloudinary") ok=ok && !!d.url;
          if(origin==="local") ok=ok && !!d.data;
          return matches && ok;
        });
      }

      loadImportedDocuments(){
        const docs=this.getFilteredDocuments();
        const tbody=document.getElementById("importedDocumentsTableBody");
        if(!docs.length){
          tbody.innerHTML='<tr><td colspan="6" style="text-align:center;">No hay documentos</td></tr>';
          return;
        }
        tbody.innerHTML=docs.map(d=>{
          const fecha=new Date(d.uploadedAt).toLocaleString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
          const origen = d.url 
            ? `<span class="badge badge-cloud">üåê Cloudinary</span>` 
            : `<span class="badge badge-local">üíª Local</span>`;
          return `<tr>
            <td>${d.name}</td>
            <td>${d.description}</td>
            <td>${fecha}</td>
            <td>${(d.size/1024).toFixed(1)} KB</td>
            <td>${origen}</td>
            <td>
              <button class="btn btn-info" onclick="documentManager.download('${d.id}')"><i class="fas fa-download"></i></button>
              <button class="btn btn-danger" onclick="documentManager.delete('${d.id}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>`;
        }).join("");
      }

      // --- Acciones ---
      download(id){
        const d=this.documents.find(x=>x.id==id);
        if(d.url) window.open(d.url,"_blank");
        else if(d.data){const a=document.createElement("a");a.href=d.data;a.download=d.name;a.click();}
      }
      delete(id){
        if(!confirm("¬øEliminar documento?"))return;
        this.documents=this.documents.filter(d=>d.id!=id);
        localStorage.setItem("documents",JSON.stringify(this.documents));
        this.loadImportedDocuments();
      }
    }

    window.addEventListener("DOMContentLoaded",()=>{window.documentManager=new DocumentManager();});
  </script>
</body>
</html>
