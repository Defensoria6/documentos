<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor Documentos con Firebase</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://upload-widget.cloudinary.com/latest/global/all.js"></script>
  <script type="module">
    // --- Firebase SDK ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // üîë Pega aqu√≠ tus credenciales de Firebase
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_PROYECTO.firebaseapp.com",
      projectId: "TU_PROYECTO",
      storageBucket: "TU_PROYECTO.appspot.com",
      messagingSenderId: "XXXXXXXXXXXX",
      appId: "1:XXXXXXXXXXXX:web:XXXXXXXXXXXX"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Gestor de documentos ---
    class DocumentManager {
      constructor() {
        this.documents = [];
        this.collectionRef = collection(db, "documents");
        this.loadDocuments();
        this.setupFileUpload();
        this.setupCloudinary();
      }

      async loadDocuments(){
        const snapshot = await getDocs(this.collectionRef);
        this.documents = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        this.renderTable();
      }

      setupFileUpload(){
        const drop=document.getElementById("fileDropZone");
        const input=document.getElementById("fileInput");
        drop.addEventListener("click",()=>input.click());
        drop.addEventListener("dragover",e=>{e.preventDefault();});
        drop.addEventListener("drop",e=>{e.preventDefault();this.handleFileSelection(e.dataTransfer.files);});
        input.addEventListener("change",e=>this.handleFileSelection(e.target.files));
      }

      async handleFileSelection(files){
        for(const f of files){
          const reader=new FileReader();
          reader.onload=async ()=>{
            const docData={name:f.name,description:"Documento local",size:f.size,uploadedAt:new Date().toISOString(),data:reader.result};
            await addDoc(this.collectionRef, docData);
            this.loadDocuments();
          };
          reader.readAsDataURL(f);
        }
      }

      setupCloudinary(){
        if(typeof cloudinary==='undefined')return;
        const widget=cloudinary.createUploadWidget(
          {cloudName:'dbzucruu4',uploadPreset:'documentos_defensoria'},
          async (err,res)=>{
            if(res.event==="success"){
              const docData={name:res.info.original_filename+"."+res.info.format,description:"Subido a Cloudinary",size:res.info.bytes,uploadedAt:new Date().toISOString(),url:res.info.secure_url};
              await addDoc(this.collectionRef, docData);
              this.loadDocuments();
            }
          }
        );
        document.getElementById("upload_widget").addEventListener("click",()=>widget.open(),false);
      }

      async deleteDocument(id){
        if(!confirm("¬øEliminar documento?"))return;
        await deleteDoc(doc(db,"documents",id));
        this.loadDocuments();
      }

      renderTable(){
        const tbody=document.getElementById("documentsTableBody");
        if(!this.documents.length){
          tbody.innerHTML='<tr><td colspan="6" style="text-align:center;">No hay documentos</td></tr>';
          return;
        }
        tbody.innerHTML=this.documents.map(d=>{
          const fecha=new Date(d.uploadedAt).toLocaleString("es-ES");
          const origen = d.url 
            ? `<span style="background:#2563eb; color:white; padding:2px 6px; border-radius:6px; font-size:0.75em;">üåê Cloudinary</span>` 
            : `<span style="background:#6b7280; color:white; padding:2px 6px; border-radius:6px; font-size:0.75em;">üíª Local</span>`;
          return `<tr>
            <td>${d.name}</td>
            <td>${d.description}</td>
            <td>${fecha}</td>
            <td>${(d.size/1024).toFixed(1)} KB</td>
            <td>${origen}</td>
            <td>
              <button class="btn btn-info" onclick="window.open('${d.url || d.data}', '_blank')"><i class="fas fa-download"></i></button>
              <button class="btn btn-danger" onclick="documentManager.deleteDocument('${d.id}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>`;
        }).join("");
      }
    }

    window.addEventListener("DOMContentLoaded",()=>{window.documentManager=new DocumentManager();});
  </script>
  <style>
    body {font-family: 'Inter', sans-serif; background: #f9fafb; margin:0; padding:20px;}
    .container {background: #fff; padding:20px; border-radius:12px; max-width:950px; margin:auto; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
    h1 {color:#2563eb; text-align:center;}
    .file-drop-zone {border:2px dashed #ccc; border-radius:10px; padding:40px; text-align:center; margin-bottom:20px; cursor:pointer;}
    .btn {padding:6px 12px; border:none; border-radius:6px; cursor:pointer; margin:2px;}
    .btn-info {background:#2563eb; color:white;}
    .btn-danger {background:#ef4444; color:white;}
    table {width:100%; border-collapse:collapse;}
    th,td {padding:10px; border-bottom:1px solid #ddd; font-size:0.9em; text-align:center;}
    th {background:#2563eb; color:white;}
  </style>
</head>
<body>
  <div class="container">
    <h1>üìÇ Gestor de Documentos con Firebase</h1>

    <div id="fileDropZone" class="file-drop-zone">
      <h3>Arrastra archivos aqu√≠ o haz clic</h3>
      <input type="file" id="fileInput" multiple style="display:none;">
    </div>

    <div style="text-align:center; margin-bottom:20px;">
      <button id="upload_widget" class="btn btn-info"><i class="fas fa-upload"></i> Subir con Cloudinary</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr><th>Nombre</th><th>Descripci√≥n</th><th>Fecha</th><th>Tama√±o</th><th>Origen</th><th>Acciones</th></tr>
        </thead>
        <tbody id="documentsTableBody">
          <tr><td colspan="6" style="text-align:center;">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</body>
</html>
